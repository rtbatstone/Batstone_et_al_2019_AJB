---
title: "data_setup"
author: "Rebecca Batstone"
date: "`r format(Sys.Date())`"
output: github_document
editor_options: 
  chunk_output_type: console
---

## Load packages

```{r setup, warning=FALSE, message=FALSE}

# packages
library("tidyverse") # includes ggplot2, dplyr, readr, stringr
library("cowplot") # paneled graphs
library("psych") # pairs.panels function, correlations of raw data
library("Amelia") # missmap function, examine missing data
```

## Spreadsheets

```{r prep_greenhouse, warning=FALSE, message=FALSE}

########### DS1
# From Anna's greehouse experiment
greenhouse <- read_csv("SimonsenStinchcombe_Proc.Roy.Soc.B_2014_rawdata_pluslinename.csv")

### DS1 set variable types:
greenhouse$line <- greenhouse$family
greenhouse$line <- as.factor(greenhouse$line)

# calc proportion white
greenhouse$prop_white <- (greenhouse$totalwhite)/(greenhouse$totalnod)
greenhouse$choice <- 1 - greenhouse$prop_white

# subset to only lines in my dataset
greenhouse_s30 <- subset(greenhouse, 
                         line %in% c('AC3','AC15','AC20','DE7','DE15','DU4','DU17','FOR15','FOR26','FOR43','F217',"F219",
                                      "F224", "HTD2", "HTD28", "HTR1", "HTR25", "HTR30", "KA7", "KA16", "KA24", "RBE17",                                         "RBE34","RBE38","WR31","WR34","WR40a","WT18","WT30","WT39"))
greenhouse_s30 <- droplevels(greenhouse_s30)

# subset to the mixed treatment only
GH_mix <- subset(greenhouse_s30, treatment == "Mix")
GH_mix <- droplevels(GH_mix)

# include a column for plant ID (unique to each plant)
GH_mix$plant_ID <- do.call(paste, c(GH_mix[c("tag","tray")], 
                                    sep = "-"))
GH_mix$plant_ID <- as.factor(GH_mix$plant_ID)

str(GH_mix)
## 282 obs., 280 plants, 30 lines

###### field dataset

# after updating merged spreadsheet
field <- read_csv("field_combined_21March2019.csv", 
    col_types = cols(batch = col_factor(levels = c("one", 
        "two")), no = col_character(), plot = col_factor(levels = c("plot_1", 
        "plot_2", "plot_3", "plot_4"))))

# set variable types
field$line <- as.factor(field$line)
field$plant_ID <- as.factor(field$plant_ID)

str(field)
## 1131 plants, 30 lines
```

### Combine Anna's raw data (N = 282 plants) with mine

```{r df_combine}
### df with: line, include column (env), 4 traits (nod, shoot, leaf, survival), researcher (include Anna)

# 1) change F2 to FZ to match my df

GH_mix$line <- recode(GH_mix$line, "F217"="FZ17", "F219"="FZ19", "F224"="FZ24")
GH_mix$population <- recode(GH_mix$population, "F2"="FZ")

# 2) select columns that match my df

GH_mix.sub <- GH_mix[ , c("tray", "block", "line","population","survival","leaf_atharvest","totalnod","plant_ID",
                          "shoot","root","choice","totalred")]

# 3) include column for env and diss

GH_mix.sub$env <- "GH"
GH_mix.sub$dataset <- "ESC-greenhouse"
GH_mix.sub$diss <- "Simonsen"
GH_mix.sub$flo <- NA
GH_mix.sub$fru <- NA

# select columns from my df that match

field.sub <- field[ , c("loc", "batch", "line","pop","shoot_BM","root_BM","survive","leaf","nod","plant_ID",
                        "plot","diss","flo","fru")]

# change case of population to upper
field.sub$pop <- toupper(field.sub$pop)

# transform shoot and root to mg to match
field.sub$shoot <- field.sub$shoot_BM * 1000
field.sub$root <- field.sub$root_BM * 1000

# drop columns shoot_BM and root_BM
drops8 <- c("shoot_BM","root_BM")
field.sub <- field.sub[ , !(names(field.sub) %in% drops8)]

# add a column for dataset
field.sub$dataset <- "KSR-field" 
field.sub$totalred <- NA
field.sub$choice <- NA

# rename columns to match
colnames(GH_mix.sub)[colnames(GH_mix.sub)=="tray"] <- "position"
colnames(GH_mix.sub)[colnames(GH_mix.sub)=="population"] <- "pop"
colnames(GH_mix.sub)[colnames(GH_mix.sub)=="leaf_atharvest"] <- "leaf"
colnames(GH_mix.sub)[colnames(GH_mix.sub)=="totalnod"] <- "nod"
colnames(field.sub)[colnames(field.sub)=="loc"] <- "position"
colnames(field.sub)[colnames(field.sub)=="batch"] <- "block"
colnames(field.sub)[colnames(field.sub)=="survive"] <- "survival"
colnames(field.sub)[colnames(field.sub)=="plot"] <- "env"

# combine into one
F_GH_ds <- rbind(GH_mix.sub, field.sub)

# change env to factor
F_GH_ds$env <- factor(F_GH_ds$env, levels = c("GH","plot_1","plot_2","plot_3","plot_4"))

str(F_GH_ds)
## 1413 obs, 1411 plants, 30 lines

write.csv(F_GH_ds, "combined_field_GH_19Aug2019.csv", row.names = FALSE)
```

## Raw data summaries

```{r raw_data_sum}
sapply(F_GH_ds,function(x) sum(is.na(x)))
sapply(F_GH_ds, function(x) length(unique(x)))

F_GH_ds_sum <- F_GH_ds %>%
  group_by(env, line) %>%
  summarise_if(is.numeric, mean, na.rm=TRUE)

F_GH_ds_count <- F_GH_ds %>%
  group_by(env, line) %>%
  summarise(count = length(line))

F_GH_sum_join <- F_GH_ds_sum %>%
  right_join(F_GH_ds_count)
```

### Examine missing data

```{r missing, warning=FALSE, message=FALSE}
missmap(F_GH_ds, main = "Missing values vs observed")
```

Traits without sufficient replication:

- fruit and flower only measured in field
- choice and number of red nodules only measured in GH
- shoot, root not available for DU17 (plot3)
- shoot not available for KA24 (plot4)
- no traits available for WR34 (plot4), none survived
- leaf, nod, flower, fruit not available for WT39 (plot4)

### Examine proportion of surviving plants btw GH and field plots

```{r prop_surv, warning=FALSE}
F_GH_ds_prop <- F_GH_ds %>%
  group_by(env, line) %>%
  summarise(prop_surv = sum(survival)/length(survival))

F_GH_ds_prop.w <- spread(F_GH_ds_prop, env, prop_surv)

plot1 <- ggplot(F_GH_ds_prop.w, aes(x=GH, y=plot_1)) + 
  geom_point(size=4, aes(color=line)) + 
  geom_smooth(method=lm, se=FALSE) +
  theme(legend.position = "none")

plot2 <- ggplot(F_GH_ds_prop.w, aes(x=GH, y=plot_2)) + 
  geom_point(size=4, aes(color=line)) + 
  geom_smooth(method=lm, se=FALSE) +
  theme(legend.position = "none")

plot3 <- ggplot(F_GH_ds_prop.w, aes(x=GH, y=plot_3)) + 
  geom_point(size=4, aes(color=line)) + 
  geom_smooth(method=lm, se=FALSE) +
  theme(legend.position = "none")

plot4 <- ggplot(F_GH_ds_prop.w, aes(x=GH, y=plot_4)) + 
  geom_point(size=4, aes(color=line)) + 
  geom_smooth(method=lm, se=FALSE) +
  theme(legend.position = "none")

(sub1 <- plot_grid(plot1, plot2, plot3, plot4, 
          ncol = 2,
          nrow = 2,
          #rel_heights = c(0.8, 1),
          align = "hv",
          labels = c("AUTO")))
```

### Raw data correlations

```{r raw_corr, warning=FALSE, message=FALSE}
(pairs.panels(F_GH_ds[,c(5:7,9:12,16:17)], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             ))
```
