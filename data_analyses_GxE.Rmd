---
title: "data_analyses_GxE"
author: "Rebecca Batstone"
date: "`r format(Sys.Date())`"
output: github_document
editor_options: 
  chunk_output_type: console
---

## Load packages

```{r setup, warning=FALSE, message=FALSE}

# packages
library("tidyverse") ## includes ggplot2, dplyr, readr, stringr
library("cowplot") ## paneled graphs
library("reshape2") ## dcast function
library("lme4") ## mixed effects models
library("emmeans") ## calc model-estimated means
library("DHARMa") ## residual diagnostics for glmm
library("fitdistrplus") ## probability distributions of data
library("car") ## Anova function
library("logistf") ## firth correction (binomial responses)
library("brglm2") ## check separation issue 
```

## Spreadsheets

```{r import_df, warning=FALSE, message=FALSE}
# created using "data_setup.Rmd"
date <- format(Sys.Date())
load(paste0("combined_field_GH_", date, ".Rdata"))
load("./dataset_cleaned/shoot_cleaned.Rdata")
load("./dataset_cleaned/survival_cleaned.Rdata")
load("./dataset_cleaned/leaves_cleaned.Rdata")
load("./dataset_cleaned/nods_cleaned.Rdata")
load("./dataset_cleaned/choice_cleaned.Rdata")
load("./dataset_cleaned/red_nod_cleaned.Rdata")
load("./dataset_cleaned/flowers_cleaned.Rdata")
load("./dataset_cleaned/fruits_cleaned.Rdata")
```

## Set to effects contrasts 

```{r set_contrasts}
options(contrasts = rep ("contr.sum", 2)) 
```

## GLMs (line as fixed effect)

### glm1: shoot

Summary:

- both models perform well, residual diagnostics hold up
- lm type III SS can be calculated, but interaction is not significant.
- glm type III SS cannot be calculated using Anova function, but joint_tests indicates all terms sig. 

```{r shoot}
# prob dist
ggplot(data=shoot_cc, aes(x=shoot)) + geom_density() + facet_grid(env ~.) ## highly right-skewed

descdist(shoot_cc$shoot, discrete = FALSE)
## normal, gamma, log normal options
fit.gamma <- fitdist(shoot_cc$shoot, "gamma")
fit.norm <- fitdist(shoot_cc$shoot, "norm")
fit.lnorm <- fitdist(shoot_cc$shoot, "lnorm")
plot(fit.gamma)
plot(fit.norm)
plot(fit.lnorm)
fit.gamma$aic 
fit.norm$aic 
fit.lnorm$aic
## lnorm, gamma, norm (best to worst)

# model
<<<<<<< HEAD

lm1 <- lm(log(shoot) ~ env * line,
            data = shoot_cc)

=======
>>>>>>> 2ddd9ca6ffb84cb35f54d0e528da88655a057fe0
glm1 <- glm(shoot ~ env * line,
            family = Gamma(link="log"),
            data = shoot_cc)

# residual diagnostics
plot(lm1) ## OK

simuOut_glm1 <- simulateResiduals(fittedModel = glm1, n = 1000)
plot(simuOut_glm1) ## OK
testDispersion(simuOut_glm1) ## NS

# model summary
(ANODEV_lm_shoot <- Anova(lm1, type = 2)) ## NS interaction, type 2 used
(joint_tests(lm1)) # matches Anova results
(ANODEV_shoot <- Anova(glm1, type = 2)) ## error if type 3, type 2 used
(joint_tests(glm1)) ## all terms sig. 
```

### glm2: survival

Summary:

- residual diagnostics hold up
- type III SS can be calculated using Anova, but warning about fitted probabilities issued
- checked separation in model, and uncovered Inf's
- used Firth's correction to deal with separation, and detected sig. ME's of line and env, but no interaction

```{r survival}
ggplot(data=survival_cc, aes(x=survival)) + geom_density() + facet_grid(env ~.) 

# prob dist
descdist(survival_cc$survival, discrete = TRUE)
## normal, poisson, negative binomial options
fit.poiss <- fitdist(survival_cc$survival, "pois")
fit.norm <- fitdist(survival_cc$survival, "norm")
fit.nbinom <- fitdist(survival_cc$survival, "nbinom")
plot(fit.norm)
plot(fit.nbinom)
plot(fit.poiss)
fit.poiss$aic 
fit.norm$aic 
fit.nbinom$aic
## norm, poisson, nbinom (best to worst)

# model
glm2 <- glm(survival ~ env * line,
             family = binomial,
               data = survival_cc)

# residual diagnostics
simuOut_glm2 <- simulateResiduals(fittedModel = glm2, n = 1000)
plot(simuOut_glm2) ## OK
testDispersion(simuOut_glm2) ## NS

# model summary
(ANODEV_survival <- Anova(glm2, type = 3)) ## interaction sig., fitted probability warning issued
(joint_tests(glm2)) ## does not match Anova function results

# Check separation issue
(glm2_check <- glm(survival ~ env * line,
             family = binomial,
               data = survival_cc,
            method = "detect_separation")) ## Inf detected

# firth correction
glm_firth <- logistf(survival ~ env * line, data = survival_cc)

glm_firth2 <- logistf(survival ~ env + line, data = survival_cc)

glm_firth3 <- logistf(survival ~ env, data = survival_cc)

glm_firth4 <- logistf(survival ~ line, data = survival_cc)

(firth_anova_int <- anova(glm_firth, glm_firth2, method = "PLR")) ## NS interaction

(firth_anova_line <- anova(glm_firth2, glm_firth3, method = "PLR")) ## sig ME of line

(firth_anova_env <- anova(glm_firth2, glm_firth4, method = "PLR")) ## sig ME of env
```

### glm3: leaf

Summary:

- glm residual diagnostics hold up, but not for lm.
- lm type III SS can be calculated, but interaction is not significant.
- glm type III SS cannot be calculated using Anova function, but joint_tests indicates all terms sig. 

```{r leaf}
# prob dist
ggplot(data=leaf_cc, aes(x=leaf)) + geom_density() + facet_grid(env ~.) ## highly right-skewed

descdist(leaf_cc$leaf, discrete = TRUE)
## normal, poisson, negative binomial options
fit.poiss <- fitdist(leaf_cc$leaf, "pois")
fit.norm <- fitdist(leaf_cc$leaf, "norm")
fit.nbinom <- fitdist(leaf_cc$leaf, "nbinom")
plot(fit.norm)
plot(fit.nbinom)
plot(fit.poiss)
fit.poiss$aic
fit.norm$aic 
fit.nbinom$aic 
## nbinom, norm, poiss (best to worst)

# model
lm3 <- lm(sqrt(leaf) ~ env * line, 
            data = leaf_cc)

glm3 <- glm.nb(leaf ~ env * line, 
            data = leaf_cc)

# residual diagnostics
plot(lm3) ## not great

simOut_glm3 <- simulateResiduals(fittedModel = glm3, n = 1000)
plot(simOut_glm3) ## OK
testDispersion(simOut_glm3) ## NS

# model summary
(ANODEV_lm_leaf <- Anova(lm3, type = 2)) ## NS interaction, type 2 used
(joint_tests(lm3)) # matches Anova results
(ANODEV_glm_leaf <- Anova(glm3, type = 2)) ## error if set to type 3, type 2 used
(joint_tests(glm3)) ## all terms sig.
```

### glm4: nod

Summary:

- glm residual diagnostics hold up, but not for lm.
- lm type III SS can be calculated, but interaction is not significant.
- glm type III SS can be calculated using Anova function and joint_tests closely matches, 
  but non-convergence warning issued

```{r nod}
# prob dist
ggplot(data=nod_cc, aes(x=nod)) + geom_density() + facet_grid(env ~.) ## highly right-skewed

descdist(nod_cc$nod, discrete = TRUE)
## normal, poisson, negative binomial options
fit.poiss <- fitdist(nod_cc$nod, "pois")
fit.norm <- fitdist(nod_cc$nod, "norm")
fit.nbinom <- fitdist(nod_cc$nod, "nbinom")
plot(fit.norm)
plot(fit.nbinom)
plot(fit.poiss)
fit.poiss$aic
fit.norm$aic 
fit.nbinom$aic 
## nbinom, norm, poisson (best to worst)

# model
lm4 <- lm(sqrt(nod) ~ env * line,
          data = nod_cc)

glm4 <- glm.nb(nod ~ env * line, 
            data = nod_cc)

# residual diagnostics
plot(lm4) ## bad

simOut_glm4 <- simulateResiduals(fittedModel = glm4, n = 1000)
plot(simOut_glm4) ## OK
testDispersion(simOut_glm4) ## NS

# model summary
(ANODEV_lm_nod <- Anova(lm4, type = 2)) ## NS interaction, type 2 used
(joint_tests(lm4)) ## matches Anova results
(ANODEV_glm_nod <- Anova(glm4, type = 3)) ## non-convergence warning
(joint_tests(glm4)) ## close to Anova results
```

### glm5: choice

Summary:

- type II SS used, no interaction

```{r choice}
# prob dist
ggplot(data=choice_cc, aes(x=choice)) + geom_density() + facet_grid(env ~.) ## normal-ish

descdist(choice_cc$choice, discrete = FALSE)
## normal, poisson, negative binomial options
fit.unif <- fitdist(choice_cc$choice, "unif")
fit.norm <- fitdist(choice_cc$choice, "norm")
plot(fit.norm)
plot(fit.unif)
fit.unif$aic 
fit.norm$aic
## norm (best to worst)

# model
glm5 <- lm(choice ~ line, 
             data = choice_cc)

# residual diagnostics
plot(glm5)

# model summary
(ANODEV_choice <- Anova(glm5, type = 2)) # no interaction term, type 2 used
```

### glm6: red nodules

Summary:

- type II SS used, no interaction

```{r red_nod}
# prob dist
ggplot(data=red_nod_cc, aes(x=totalred)) + geom_density() + facet_grid(env ~.) ## right skewed

descdist(red_nod_cc$totalred, discrete = TRUE)
## normal, poisson, negative binomial options
fit.poiss <- fitdist(red_nod_cc$totalred, "pois")
fit.norm <- fitdist(red_nod_cc$totalred, "norm")
fit.nbinom <- fitdist(red_nod_cc$totalred, "nbinom")
plot(fit.norm)
plot(fit.nbinom)
plot(fit.poiss)
fit.poiss$aic 
fit.norm$aic 
fit.nbinom$aic 
## nbinom, norm, poisson (best to worst)

# model
glm6 <- glm.nb(totalred ~ line,
                data = subset(red_nod_cc, survival > 0))

# residual diagnostics
simOut_glm6 <- simulateResiduals(fittedModel = glm6, n = 1000)
plot(simOut_glm6) ## OK
testDispersion(simOut_glm6) ## NS

# model summary
(ANODEV_totalred <- Anova(glm6, type = 2)) ## no interaction term, type 2 used
```

### glm7: flower

Summary:

- residual diagnostics hold up
- type III SS can be calculated using Anova, but warning about fitted probabilities issued
- checked separation in model, and uncovered Inf's
- used Firth's correction to deal with separation, and detected sig. ME's of line and env, but no interaction

```{r flower}
# prob dist
ggplot(data=flower_cc, aes(x=flo)) + geom_density() + facet_grid(env ~ .) ## highly right-skewed

descdist(flower_cc$flo, discrete = TRUE)
## normal, poisson, negative binomial options
fit.poiss <- fitdist(flower_cc$flo, "pois")
fit.norm <- fitdist(flower_cc$flo, "norm")
fit.nbinom <- fitdist(flower_cc$flo, "nbinom")
plot(fit.norm)
plot(fit.nbinom)
plot(fit.poiss)
fit.poiss$aic 
fit.norm$aic 
fit.nbinom$aic 
## nbinom, poisson, norm (best to worst)

# calculate flower success
flower_cc$flo_succ <- as.numeric(flower_cc$flo > 0) 

# model
glm7 <- glm(flo_succ ~ env * line,
             family= binomial,
             data = subset(flower_cc, survival > 0))

# residual diagnostics
simOut_glm7 <- simulateResiduals(fittedModel = glm7, n = 1000)
plot(simOut_glm7) ## OK
testDispersion(simOut_glm7) ## NS

# model summary
(ANODEV_flo <- Anova(glm7, type = 3)) ## no terms sig., fitted probability warning issued
(joint_tests(glm7)) ## matches Anova results

# Check separation issue
(glm7_check <- glm(flo_succ ~ env * line,
             family= binomial,
             data = subset(flower_cc, survival > 0),
            method = "detect_separation")) ## Inf detected

# firth correction
glm7_firth <- logistf(flo_succ ~ env * line, data = subset(flower_cc, survival > 0))

glm7_firth2 <- logistf(flo_succ ~ env + line, data = subset(flower_cc, survival > 0))

glm7_firth3 <- logistf(flo_succ ~ env, data = subset(flower_cc, survival > 0))

glm7_firth4 <- logistf(flo_succ ~ line, data = subset(flower_cc, survival > 0))

(firth_anova_int <- anova(glm7_firth, glm7_firth2, method = "PLR")) ## NS interaction

(firth_anova_line <- anova(glm7_firth2, glm7_firth3, method = "PLR")) ## sig ME of line

(firth_anova_env <- anova(glm7_firth2, glm7_firth4, method = "PLR")) ## sig ME of env
```

### glm8: fruit

Summary:

- residual diagnostics hold up on binomial data, not count data 

Binomial:
- type III SS can be calculated using Anova, but warning about fitted probabilities issued
- checked separation in model, and uncovered Inf's
- used Firth's correction to deal with separation, and detected sig. ME's of line and env, but no interaction

```{r fruit}
# prob dist
ggplot(data=fruit_cc, aes(x=fru)) + geom_density() + facet_grid(env ~.) ## highly right-skewed

descdist(fruit_cc$fru, discrete = TRUE)
## normal, poisson, negative binomial options
fit.poiss <- fitdist(fruit_cc$fru, "pois")
fit.norm <- fitdist(fruit_cc$fru, "norm")
fit.nbinom <- fitdist(fruit_cc$fru, "nbinom")
plot(fit.norm)
plot(fit.nbinom)
plot(fit.poiss)
fit.poiss$aic 
fit.norm$aic 
fit.nbinom$aic 
## nbinom, norm, poisson  (best to worst)

# calculate fruit success
fruit_cc$fru_succ <- as.numeric(fruit_cc$fru > 0) 

# models
lm8_nz <- lm(sqrt(fru) ~ env * line, 
              data = subset(fruit_cc, fru > 0))

glm8_nz <- glm.nb(fru ~ env * line, 
              data = subset(fruit_cc, fru > 0))

glm8_succ <- glm(fru_succ ~ env * line, 
              family = binomial,   
              data = fruit_cc)

# residual diagnostics
plot(lm8_nz) ## OK

simOut_glm8_nz <- simulateResiduals(fittedModel = glm8_nz, n = 1000)
plot(simOut_glm8_nz) ## bad
testDispersion(simOut_glm8_nz) ## NS

simOut_glm8_succ <- simulateResiduals(fittedModel = glm8_succ, n = 1000)
plot(simOut_glm8_succ) ## OK
testDispersion(simOut_glm8_succ) ## NS

# model summaries
(ANODEV_lm_fru_nz <- Anova(lm8_nz, type = 2)) ## singular, cannot assess type 3, type 2 used
(joint_tests(lm8_nz)) ## matches Anova results
(ANODEV_glm_fru_nz <- Anova(glm8_nz, type = 2)) ## singular, cannot assess type 3, type 2 used
(joint_tests(glm8_nz)) ## matches Anova results

(ANODEV_fru_succ <- Anova(glm8_succ, type = 3)) ## no terms sig., fitted probability warning issued
(joint_tests(glm8_succ)) ## close to Anova results

# Check separation issue
(glm8_check <- glm(fru_succ ~ env * line, 
              family = binomial,   
              data = fruit_cc,
            method = "detect_separation")) ## Inf detected

# firth correction
glm8_firth <- logistf(fru_succ ~ env * line, data = fruit_cc)

glm8_firth2 <- logistf(fru_succ ~ env + line, data = fruit_cc)

glm8_firth3 <- logistf(fru_succ ~ env, data = fruit_cc)

glm8_firth4 <- logistf(fru_succ ~ line, data = fruit_cc)

(firth_anova_int <- anova(glm8_firth, glm8_firth2, method = "PLR")) ## NS interaction

(firth_anova_line <- anova(glm8_firth2, glm8_firth3, method = "PLR")) ## marg sig ME of line

(firth_anova_env <- anova(glm8_firth2, glm8_firth4, method = "PLR")) ## sig ME of env
```

